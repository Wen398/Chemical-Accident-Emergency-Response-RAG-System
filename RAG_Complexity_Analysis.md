# RAG 架構與邏輯複雜度分析報告

為協助團隊決定「資料庫層」與「Agent 層」的邏輯分工，以下針對兩種 RAG 策略進行比較分析。

## 策略選項

*   **選項 A：切割檢索 (Chunked Retrieval)** [原方案]
    *   將應變指南切分為「潛在危害」、「公眾安全」、「緊急應變」小塊。
    *   Agent 發問時需指定意圖（例如「我要查滅火」），資料庫只回傳相關段落。
*   **選項 B：完整回傳 (Full Guide Retrieval)** [您提出的新方向]
    *   Agent 只要確認 Guide Number，資料庫就回傳該指南的「全文」。
    *   Agent 拿到全文後，自行閱讀並回答問題。

## 比較分析

| 比較項目 | 選項 A：切割檢索 (Chunked) | 選項 B：完整回傳 (Full Guide) |
| :--- | :--- | :--- |
| **資料庫查詢複雜度** | **高** (需 Embed 更多段落，查詢需指定篩選條件) | **低** (只需 ID 查詢，邏輯單純) |
| **Agent / LLM 閱讀負擔** | **低** (只讀 300-500 字，專注相關資訊) | **高** (需讀 1000-2000 字，包含無關資訊) |
| **Token 消耗 (成本)** | **節省** (只傳送必要段落給 LLM) | **較高** (每次都傳送整篇指南) |
| **回答準確度 (幻覺風險)** | **較低** (雜訊少，LLM 不會混淆其他章節) | **中等** (若指南太長，LLM 可能看錯行) |
| **跨單元推理能力** | **受限** (需多次查詢才能拼湊全貌) | **強** (LLM 一眼看到全文，易於綜合判斷) |
| **開發難度** | **較高** (需設計良好的 Prompt 來選對章節) | **簡單** (Prompt 只要說「讀這篇指南」) |

## 邏輯分工建議表

針對您的系統需求（ERG 緊急應變），我們建議採用 **混合模式**：以「完整回傳」為主，透過 Agent 進行邏輯判斷。

| 邏輯任務類型 | 建議存放位置 | 說明 |
| :--- | :--- | :--- |
| **物質名稱辨識** (Ex: 判斷 Chlorine) | **資料庫層** | 這是「硬數據」，不可出錯。使用 Metadata Filter 確保精確比對。 |
| **危害數值查詢** (Ex: 隔離距離) | **資料庫層** | 這是「查表」，直接從 Metadata 讀取數值最準，不要讓 LLM 去讀文字。 |
| **複雜情境判斷** (Ex: 下雨+火災) | **Agent 層** | 牽涉因果關係。Agent 讀取完整指南(選項B)後，綜合判斷。 |
| **應變決策** (Ex: 先救人還是先滅火?) | **Agent 層** | 這是決策邏輯。Agent 解讀指南中的優先順序 (如 "Call 911 first")。 |
| **多物質交叉影響** (Ex: 兩個化學品混合) | **Agent 層** | 資料庫無法預存所有混合結果。需 Agent 讀取兩份指南後進行推理。 |

## 結論與下一步建議

基於您希望 **「簡化資料庫查詢，強調 Agent 開發」** 的方向，**選項 B (完整回傳)** 是目前最佳選擇。

1.  **資料庫**：保持目前的分割儲存結構（不用改建置程式），但在查詢時使用 `consult_guide` 聚合所有段落，一次吐回 Agent。
2.  **Agent**：
    *   收到完整的指南 Context。
    *   Prompt 設計重點：*"請閱讀以下完整指南，針對使用者的情境（如火災），提取相關部分回答。"*

這樣的設計可以大幅降低資料庫介面開發的負擔，將智慧集中在 LLM 本身。
